<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Award List Portal - G.P.S SALOBAIG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --zong-pink: #df1b77; --zong-green: #8cc63f; --bg: #f0f2f5; --save-blue: #007bff; --danger: #dc3545; --dark-slate: #2c3e50; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; }

        .click-guide { font-size: 10px; color: var(--zong-pink); font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 3px; }
        .click-guide i { font-size: 11px; }

        .edit-icon-label { font-size: 10px; color: #fff; opacity: 0.8; margin-bottom: 2px; display: block; }
        .input-group { position: relative; margin-bottom: 12px; }
        
        .input-group i, .sig-input-wrapper i, .top-input-icon-wrapper i, .sig-settings label i, #roll-info i { color: var(--zong-pink) !important; }
        .input-group i { position: absolute; left: 12px; top: 15px; }
        .input-box-icon { padding-left: 35px !important; }

        .app-view { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; padding-bottom: 20px; border: 1px solid #ddd; display: flex; flex-direction: column; }
        .app-header { background: linear-gradient(135deg, var(--zong-pink), #9d1252); color: white; padding: 15px; text-align: center; }
        
        .header-edit-container { position: relative; margin-bottom: 8px; }
        .header-edit-container i { position: absolute; right: 10px; top: 10px; font-size: 12px; color: rgba(255,255,255,0.7) !important; pointer-events: none; }
        .edit-head { width: 100%; background: rgba(255,255,255,0.15); border: 1px dashed white; color: white; text-align: center; border-radius: 5px; padding: 8px; font-weight: bold; outline: none; padding-right: 30px; }
        
        .top-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #fff; border-bottom: 2px solid #eee; position: sticky; top: 0; z-index: 100; }
        .btn { padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 12px; }
        .btn i { color: white !important; }

        .form-section { padding: 15px; flex-grow: 1; }
        .student-card { background: white; padding: 15px; border-radius: 15px; border: 1.5px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .input-box { width: 100%; padding: 12px; border: 1.2px solid #ccc; border-radius: 10px; font-size: 16px; font-weight: 600; outline: none; }

        .subjects-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
        .sub-card { background: #fff0f6; border: 1px solid #fcc2d7; padding: 8px; border-radius: 10px; text-align: center; position: relative; }
        .sub-card.locked { background: #f1f3f5 !important; border: 1px solid #dee2e6 !important; opacity: 0.6; }
        .sub-card label { display: block; font-size: 10px; font-weight: 900; margin-bottom: 2px; color: var(--dark-slate); }
        .sub-card i.edit-dot { font-size: 7px; color: var(--zong-pink) !important; position: absolute; right: 5px; top: 5px; }
        .sub-card input { width: 100%; border: none; background: transparent; text-align: center; font-size: 18px; font-weight: bold; outline: none; border-bottom: 1px solid transparent; color: var(--zong-pink); }
        
        .total-box { margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 10px; text-align: center; font-weight: 900; border: 2px solid var(--zong-green); }
        .nav-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 0 10px; }
        
        .nav-btn { background: var(--zong-pink); color: white; border: none; padding: 12px 18px; border-radius: 30px; font-weight: 900; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .nav-btn i { color: white !important; }

        .sig-settings { margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        .sig-input-wrapper { position: relative; }
        .sig-input-wrapper i { position: absolute; right: 8px; top: 8px; font-size: 10px; }
        .sig-input { width: 100%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }

        .top-input-icon-wrapper { position: relative; display: flex; align-items: center; }
        .top-input-icon-wrapper i { position: absolute; left: 8px; z-index: 5; pointer-events: none; font-size: 12px; } 
        .icon-padding { padding-left: 25px !important; padding-right: 5px !important; } 

        .app-footer { text-align: center; padding: 15px; color: #666; font-size: 13px; border-top: 1px solid #eee; }

        #dynamic-print-container { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .no-print { display: none !important; }
            #dynamic-print-container { display: block !important; width: 100%; }
            .print-page { width: 210mm; height: 296mm; padding: 10mm; margin: 0 auto; page-break-after: always; position: relative; box-sizing: border-box; }
            .a4-head { text-align: center; text-decoration: underline; font-size: 16pt; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; }
            .a4-info-bar { display: flex; justify-content: space-between; font-weight: 900; font-size: 10pt; margin-bottom: 10px; border-bottom: 2px solid black; padding-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; border: 2px solid black; table-layout: fixed; }
            
            /* HIGHLIGHTED HEADINGS FOR PRINT */
            th { background-color: #f2f2f2 !important; border: 1px solid black; text-align: center; padding: 3px; font-size: 8.5pt; font-weight: 900; height: 25px; -webkit-print-color-adjust: exact; }
            
            td { border: 1px solid black; text-align: center; padding: 3px; font-size: 8.5pt; font-weight: 900; height: 25px; overflow: hidden; }
            .fail-text { color: red !important; font-size: 7pt; display: block; line-height: 0.8; }
            .print-stats-bottom { font-weight: 900; font-size: 10pt; display: flex; justify-content: space-around; border-top: 1px dashed black; padding-top: 10px; margin-bottom: 40px; }
            .signature-row { display: flex; justify-content: space-around; }
            .sig-box { border-top: 1.5px solid black; width: 150px; text-align: center; font-weight: bold; font-size: 10pt; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="no-print" style="max-width: 650px; margin: 20px auto; padding: 20px; background: #fff; border: 2px solid #df1b77; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
    <h3 style="text-align: center; color: #df1b77; font-family: sans-serif; margin-bottom: 20px;">
        System Preview: Input & Output
    </h3>
    <svg viewBox="0 0 600 580" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; background: white;">
        <text x="10" y="20" font-family="Arial" font-size="14" font-weight="bold" fill="#333">1. DIGITAL INPUT (Current Design)</text>
        <rect x="10" y="30" width="280" height="150" rx="10" fill="white" stroke="#df1b77" stroke-width="2"/>
        <text x="25" y="55" font-family="Arial" font-size="10" font-weight="bold" fill="#df1b77">Roll No: 1</text>
        <rect x="25" y="65" width="250" height="20" rx="4" fill="#f9f9f9" stroke="#ddd"/>
        <text x="32" y="79" font-family="Arial" font-size="9" fill="#888">Student Name: Sajjad Ali</text>
        
        <g transform="translate(25, 100)">
            <rect x="0" y="0" width="50" height="35" rx="5" fill="#fff0f6" stroke="#fcc2d7"/>
            <text x="25" y="12" text-anchor="middle" font-family="Arial" font-size="8" font-weight="bold">ENG</text>
            <text x="25" y="28" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#df1b77">85</text>
            
            <rect x="60" y="0" width="50" height="35" rx="5" fill="#fff0f6" stroke="#fcc2d7"/>
            <text x="85" y="12" text-anchor="middle" font-family="Arial" font-size="8" font-weight="bold">URD</text>
            <text x="85" y="28" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#df1b77">72</text>
            
            <rect x="120" y="0" width="50" height="35" rx="5" fill="#fff0f6" stroke="#fcc2d7"/>
            <text x="145" y="12" text-anchor="middle" font-family="Arial" font-size="8" font-weight="bold">MAT</text>
            <text x="145" y="28" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#df1b77">90</text>
        </g>

        <path d="M300 100 Q 350 100, 350 200" stroke="#ccc" stroke-width="3" fill="none" stroke-dasharray="5" marker-end="url(#arrowhead)"/>
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#ccc" />
            </marker>
        </defs>

        <text x="10" y="210" font-family="Arial" font-size="14" font-weight="bold" fill="#333">2. ORIGINAL PRINT OUTPUT (A4 Format)</text>
        <rect x="10" y="225" width="580" height="335" fill="white" stroke="black" stroke-width="1.5"/>
        <text x="300" y="245" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" text-decoration="underline">STUDENT AWARD LIST - 2026</text>
        
        <g font-family="Arial" font-size="8" font-weight="bold">
            <text x="25" y="265">SCHOOL: G.P.S SALOBAIG</text>
            <text x="200" y="265">CLASS: KG</text>
            <text x="320" y="265">SECTION: A</text>
            <text x="450" y="265">EXAM: 1ST SEM</text>
        </g>

        <rect x="20" y="275" width="560" height="120" fill="none" stroke="black" stroke-width="1"/>
        <rect x="20" y="275" width="560" height="25" fill="#e0e0e0" /> <line x1="20" y1="300" x2="580" y2="300" stroke="black" stroke-width="1"/>
        
        <g stroke="black" stroke-width="1">
            <line x1="50" y1="275" x2="50" y2="395"/> 
            <line x1="140" y1="275" x2="140" y2="395"/> 
            <line x1="230" y1="275" x2="230" y2="395"/> 
            <line x1="260" y1="275" x2="260" y2="395" stroke-width="0.5"/> 
            <line x1="290" y1="275" x2="290" y2="395" stroke-width="0.5"/> 
            <line x1="320" y1="275" x2="320" y2="395" stroke-width="0.5"/> 
            <line x1="350" y1="275" x2="350" y2="395" stroke-width="0.5"/> 
            <line x1="380" y1="275" x2="380" y2="395" stroke-width="0.5"/> 
            <line x1="520" y1="275" x2="520" y2="395"/> 
        </g>

        <g font-family="Arial" font-size="7" font-weight="bold" text-anchor="middle">
            <text x="35" y="290">RN</text>
            <text x="95" y="290">STUDENT NAME</text>
            <text x="185" y="290">FATHER NAME</text>
            <text x="245" y="290">ENG</text>
            <text x="275" y="290">URD</text>
            <text x="305" y="290">MAT</text>
            <text x="335" y="290">SCI</text>
            <text x="365" y="290">ISL</text>
            <text x="550" y="290">TOTAL</text>
        </g>

        <g font-family="Arial" font-size="8">
            <text x="35" y="318" text-anchor="middle">1</text>
            <text x="55" y="318">Sajjad Ali</text>
            <text x="145" y="318">Ali Ahmad</text>
            <text x="245" y="318" text-anchor="middle">85</text>
            <text x="550" y="318" text-anchor="middle" font-weight="bold">247</text>
            <line x1="20" y1="330" x2="580" y2="330" stroke="black" stroke-width="0.5"/>
            
            <text x="35" y="348" text-anchor="middle">2</text>
            <text x="55" y="348">Ayesha Khan</text>
            <text x="145" y="348">Umar Khan</text>
            <text x="245" y="348" text-anchor="middle">92</text>
            <text x="550" y="348" text-anchor="middle" font-weight="bold">265</text>
            <line x1="20" y1="360" x2="580" y2="360" stroke="black" stroke-width="0.5"/>

            <text x="35" y="378" text-anchor="middle">3</text>
            <text x="55" y="378">Bilal Raza</text>
            <text x="145" y="378">Hassan Raza</text>
            <text x="245" y="378" text-anchor="middle">78</text>
            <text x="550" y="378" text-anchor="middle" font-weight="bold">230</text>
        </g>

        <g font-family="Arial" font-size="8" font-weight="bold">
            <text x="25" y="420">Appeared: 3</text>
            <text x="150" y="420">Pass: 3</text>
            <text x="250" y="420">Fail: 0</text>
            <text x="350" y="420">Pass %: 100%</text>
        </g>

        <line x1="50" y1="490" x2="180" y2="490" stroke="black"/>
        <text x="115" y="505" text-anchor="middle" font-family="Arial" font-size="10" font-weight="bold">Class Teacher</text>
        <line x1="420" y1="490" x2="550" y2="490" stroke="black"/>
        <text x="485" y="505" text-anchor="middle" font-family="Arial" font-size="10" font-weight="bold">Head Master</text>
    </svg>
</div>



<div class="app-view no-print">
    <div class="app-header">
        <div class="header-edit-container">
            <span class="edit-icon-label"><i class="fas fa-edit"></i> Click to edit list title</span>
            <input type="text" id="edit-title" class="edit-head" value="STUDENT AWARD LIST - 2026" oninput="renderTable()">
            <i class="fas fa-pen-nib"></i>
        </div>
        <div class="header-edit-container">
            <span class="edit-icon-label"><i class="fas fa-edit"></i> Click to edit school name</span>
            <input type="text" id="edit-school" class="edit-head" value="G.P.S SALOBAIG" oninput="renderTable()">
            <i class="fas fa-pen-nib"></i>
        </div>
    </div>

    <div class="top-nav">
        <button class="btn" style="background:var(--save-blue)" onclick="saveToDisk()"><i class="fas fa-save"></i> SAVED</button>
        <button class="btn" style="background:var(--zong-green)" onclick="downloadPDF()"><i class="fas fa-file-download"></i> DOWNLOAD PDF</button>
        <button class="btn" style="background:#28a745" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> EXCEL EXPORT</button>
        <button class="btn" style="background:orange; color:black" onclick="clearCurrentRow()"><i class="fas fa-user-minus"></i> DELETE STUDENT</button>
        <button class="btn" style="background:var(--danger)" onclick="deleteWholeClass()"><i class="fas fa-trash-alt"></i> DELETE CLASS DATA</button>
        <button class="btn" style="background:var(--danger); grid-column: span 1;" onclick="clearAllSystemData()">
            <i class="fas fa-exclamation-triangle"></i> DELETE ALL DATA 
        </button>
    </div>

    <div class="form-section">
        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
            <div style="display:flex; gap:8px;">
                <div style="flex:1.5;">
                    <span class="click-guide no-print"><i class="fas fa-arrow-down"></i> Select Class</span>
                    <div class="top-input-icon-wrapper">
                        <i class="fas fa-chalkboard"></i>
                        <select id="classSel" onchange="changeClass(this.value)" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border:1px solid #ccc; font-size:12px;">
                            <option value="KG">Class: KG</option>
                            <option value="1ST">Class: 1ST</option>
                            <option value="2ND">Class: 2ND</option>
                            <option value="3RD">Class: 3RD</option>
                            <option value="4TH">Class: 4TH</option>
                            <option value="5TH">Class: 5TH</option>
                            <option value="6TH">Class: 6TH</option>
                            <option value="7TH">Class: 7TH</option>
                            <option value="8TH">Class: 8TH</option>
                        </select>
                    </div>
                </div>
                
                <div style="width:65px; flex:none;">
                    <span class="click-guide no-print"><i class="fas fa-arrow-down"></i> Sec</span>
                    <div class="top-input-icon-wrapper">
                        <i class="fas fa-layer-group"></i>
                        <input type="text" id="sectionInp" placeholder="Sec" value="A" oninput="renderTable()" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; text-align:center; border:1px solid #ccc; font-size:12px;">
                    </div>
                </div>

                <div style="flex:2;">
                    <span class="click-guide no-print"><i class="fas fa-arrow-down"></i> Exam Mode</span>
                    <div class="top-input-icon-wrapper">
                        <i class="fas fa-file-signature"></i>
                        <select id="modeSel" onchange="changeMode(this.value)" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border:1px solid #ccc; font-size:11px;">
                            <option value="1st">1st Sem (45%)</option>
                            <option value="Final">Annual exam</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="percCont" style="display: none; margin-top: 5px;">
                <select id="percSel" onchange="changePerc(this.value)" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border: 2px solid var(--zong-green);"></select>
            </div>
            
            <div class="sig-settings no-print">
                <span class="click-guide no-print"><i class="fas fa-arrow-down"></i> Edit Signature Titles</span>
                <label class="no-print" style="font-size: 0.85rem; font-weight: bold;"><i class="fas fa-signature"></i> Signature:</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div class="sig-input-wrapper"><input type="text" id="sig1-edit" class="sig-input" value="Class Teacher" oninput="renderTable()"><i class="fas fa-marker"></i></div>
                    <div class="sig-input-wrapper"><input type="text" id="sig2-edit" class="sig-input" value="Head Master" oninput="renderTable()"><i class="fas fa-marker"></i></div>
                </div>
                <div id="sig3-cont" style="display:none" class="sig-input-wrapper"><input type="text" id="sig3-edit" class="sig-input" value="Controller of Exam" oninput="renderTable()"><i class="fas fa-marker"></i></div>
            </div>
        </div>

        <div class="student-card">
            <div id="roll-info" style="font-weight:900; color:var(--zong-pink); margin-bottom:10px;"><i class="fas fa-id-badge"></i> Roll No: 1</div>
            <div class="input-group"><i class="fas fa-user-graduate"></i><input type="text" id="sName" class="input-box input-box-icon" placeholder="Student Name" oninput="updateData('n', this.value)"></div>
            <div class="input-group"><i class="fas fa-users"></i><input type="text" id="fName" class="input-box input-box-icon" placeholder="Father Name" oninput="updateData('f', this.value)"></div>
            
            <span class="click-guide no-print" style="margin-top:10px;"><i class="fas fa-keyboard"></i> Enter Marks below:</span>
            <div class="subjects-grid" id="subGrid"></div>
            
            <div id="total-container" class="total-box">TOTAL: <span id="live-total" style="color:var(--zong-pink); font-size:22px;">0</span> <span id="live-status" style="font-size: 12px; padding: 2px 8px; border-radius: 5px; color: white; margin-left: 10px;"></span></div>
        </div>

        <div class="nav-controls no-print">
            <button class="nav-btn" onclick="nav(-1)"><i class="fas fa-chevron-left"></i> PREVIOUS</button>
            <span id="page-indicator" style="font-weight:900; font-size:18px; color:#444;">1 / 100</span>
            <button class="nav-btn" onclick="nav(1)">NEXT <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="no-print" style="margin: 40px 15px; padding: 40px; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; text-align: center; position: relative;">
        <h2 style="margin: 0; font-family: 'Times New Roman', serif; font-size: 28px; color: #1a1a1a; font-weight: 400;">Assalamualaikum</h2>
        <div style="width: 80px; height: 1.5px; background: #df1b77; margin: 20px auto;"></div>

        <div style="max-width: 650px; margin: 0 auto;">
            <p style="font-family: 'Georgia', serif; font-size: 19px; line-height: 1.8; color: #2c3e50; font-style: italic; margin-bottom: 30px;">
                "A teacher is the compass that activates the magnets of curiosity, knowledge, and wisdom in the pupils. Every mark you record here is not just a number; it is a testament to a child's effort and your dedicated mentorship."
            </p>
            
            <p style="font-size: 14px; color: #576574; line-height: 1.6; text-align: justify; background: #f9fafb; padding: 20px; border-radius: 6px; border: 1px solid #f1f2f6;">
                <strong>Respected Educator,</strong><br>
                The integrity of this Award List is the foundation of our students' academic journey. As you finalize these records, please ensure that every entry reflects the true merit of the student.
            </p>
        </div>

        <span style="display: block; font-size: 11px; color: #95a5a6; text-transform: uppercase; letter-spacing: 2px;">Developed with Respect by</span>
        <strong style="font-size: 22px; color: #1a1a1a; font-family: 'Arial', sans-serif;">SAJJAD ALI</strong>
        <p style="margin: 5px 0 0 0; font-size: 12px; color: #df1b77; font-weight: 600;">Educational Support & Technology</p>
    </div>

    <footer class="no-print" style="text-align: center; padding-bottom: 60px;">
        <a href="https://wa.me/923073736743" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px; background: #25D366; color: white; padding: 12px 25px; border-radius: 4px; font-weight: bold; font-size: 13px; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2);">
            <i class="fab fa-whatsapp"></i> CONTACT FOR TECHNICAL ASSISTANCE
        </a>
    </footer>
</div>

<div id="dynamic-print-container"></div>

<script>
    /* Javascript logic exactly restored */
    let WEIGHT = 0.45, PASS_THRESHOLD = 0.33, currentMode = "1st", currentClass = "KG", activeIdx = 0, maxReachedIdx = 0, students = [];

    function clearAllSystemData() { if(confirm("DANGER: Delete All Classes data permanently?")) { localStorage.clear(); location.reload(); } }
    function getStoreKey() { return 'AwardData_ModeSplit_' + currentClass + '_' + currentMode; }
    
    function getPassCriteria() {
        if (currentMode === "Final") {
            let maxMarks = (currentClass === "KG") ? 500 : (["1ST", "2ND", "3RD"].includes(currentClass)) ? 700 : (["4TH", "5TH"].includes(currentClass)) ? 800 : 900;
            return maxMarks * PASS_THRESHOLD;
        }
        return (currentClass === "KG") ? 74 : (["1ST", "2ND", "3RD"].includes(currentClass)) ? 102 : (["4TH", "5TH"].includes(currentClass)) ? 118 : 133;
    }

    function updatePercOptions() {
        const container = document.getElementById('percCont');
        if(currentMode === "Final") {
            container.style.display = "block"; document.getElementById('percSel').innerHTML = '';
            for(let i=10; i<=45; i++) {
                let opt = document.createElement('option'); opt.value = i/100; opt.innerHTML = `Set Passing Marks: ${i}%`;
                if(i === 33) opt.selected = true; document.getElementById('percSel').appendChild(opt);
            }
        } else { container.style.display = "none"; PASS_THRESHOLD = 0.33; }
    }

    function getSubjects() {
        if (["1ST", "2ND", "3RD"].includes(currentClass)) return ["ENG","URD","MAT","G.K","ISL","NQ","PSH","S.S","D.G"];
        if (["6TH", "7TH", "8TH"].includes(currentClass)) return ["ENG","URD","MAT","SCI","ISL","ARB","HIS","GEO","COMP"];
        return ["ENG","URD","MAT","SCI","ISL","NQ","PSH","S.S","D.G"];
    }

    function isLocked(mi) {
        if (currentClass === "KG") return [3, 4, 5, 7].includes(mi);
        if (["1ST", "2ND", "3RD"].includes(currentClass)) return [7].includes(mi);
        return false;
    }

    function init() {
        let saved = JSON.parse(localStorage.getItem(getStoreKey()));
        students = saved || Array.from({length: 100}, () => ({n:'', f:'', m:Array(9).fill('')}));
        let lastFilled = 0; students.forEach((s, i) => { if(s.n || s.f) lastFilled = i; });
        maxReachedIdx = lastFilled;
        const subjects = getSubjects();
        document.getElementById('subGrid').innerHTML = subjects.map((s, i) => {
            const locked = isLocked(i);
            return `<div class="sub-card ${locked ? 'locked' : ''}">${locked ? '' : '<i class="fas fa-pencil-alt edit-dot"></i>'}<label>${s}</label><input type="text" inputmode="decimal" pattern="[0-9.]*" id="m-${i}" onblur="manualMarkEntry(${i}, this.value)" ${locked ? 'disabled' : ''}></div>`;
        }).join('');
        document.getElementById('sig3-cont').style.display = ["6TH", "7TH", "8TH"].includes(currentClass) ? 'block' : 'none';
        load(activeIdx);
    }

    function load(idx) {
        activeIdx = idx; if(idx > maxReachedIdx) maxReachedIdx = idx;
        const s = students[activeIdx];
        document.getElementById('roll-info').innerHTML = `<i class="fas fa-id-badge"></i> Roll No: ` + (idx + 1);
        document.getElementById('page-indicator').innerText = (idx + 1) + " / 100";
        document.getElementById('sName').value = s.n || ""; document.getElementById('fName').value = s.f || "";
        getSubjects().forEach((_, i) => { let input = document.getElementById(`m-${i}`); if(input) input.value = s.m[i] || ""; });
        updateLiveTotal(); renderTable();
    }

    function manualMarkEntry(mi, val) {
        const sanitized = val.replace(/[^0-9.]/g, '');
        if (sanitized === "") { students[activeIdx].m[mi] = ''; } 
        else {
            let num = parseFloat(sanitized); const subjects = getSubjects(); const currentSub = subjects[mi];
            if (currentSub === "ISL" && num > 60) { alert("Islamiat max 60"); num = 60; } 
            else if (currentSub === "NQ" && num > 40) { alert("Nazra Quran max 40"); num = 40; } 
            else if (num > 100) { alert("Max 100"); num = 100; }
            let finalVal = (currentMode === "1st") ? (num * 0.45).toFixed(1) : num;
            students[activeIdx].m[mi] = finalVal; document.getElementById(`m-${mi}`).value = finalVal;
        }
        updateLiveTotal(); renderTable(); saveToDisk();
    }

    function updateLiveTotal() {
        let total = students[activeIdx].m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
        document.getElementById('live-total').innerText = Math.round(total);
        const st = document.getElementById('live-status'); const passLimit = getPassCriteria();
        if (total >= passLimit && (students[activeIdx].n !== "" || total > 0)) { st.innerText = "PASS"; st.style.backgroundColor = "var(--zong-green)"; } 
        else { st.innerText = "FAIL"; st.style.backgroundColor = "var(--danger)"; }
    }

    function downloadPDF() { window.print(); }

    function exportToExcel() {
        const title = document.getElementById('edit-title').value;
        const school = document.getElementById('edit-school').value;
        const section = document.getElementById('sectionInp').value.toUpperCase();
        const subjects = getSubjects();
        let csv = `"${title}"\n`;
        csv += `"${school}","","CLASS: ${currentClass}","SECTION: ${section}","EXAM: ${currentMode.toUpperCase()}"\n\n`;
        csv += 'Roll No,Student Name,Father Name,' + subjects.join(',') + ',Total\n';
        students.slice(0, maxReachedIdx + 1).forEach((s, i) => {
            if(s.n || s.f) {
                let total = Math.round(s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0));
                csv += `${i+1},"${s.n}","${s.f}",${s.m.join(',')},${total}\n`;
            }
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `${school}_Class_${currentClass}.csv`);
        link.click();
    }

    /* Modified renderTable to handle dynamic filename */
function renderTable() {
    let app = 0, pass = 0, fail = 0; 
    const passLimit = getPassCriteria();
    const studentsPerPage = 32; 
    const filledStudents = students.slice(0, maxReachedIdx + 1);
    
    // --- DYNAMIC FILENAME LOGIC ---
    const schoolName = document.getElementById('edit-school').value;
    document.title = `Class ${currentClass} ${schoolName}`; 
    // ------------------------------

    filledStudents.forEach(s => {
        let total = s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
        if(s.n.trim() !== "" || total > 0) { app++; if(total >= passLimit) pass++; else fail++; }
    });
    
    const container = document.getElementById('dynamic-print-container'); 
    container.innerHTML = ''; 
    
    for (let i = 0; i < filledStudents.length; i += studentsPerPage) {
        const chunk = filledStudents.slice(i, i + studentsPerPage);
        const pageDiv = document.createElement('div'); 
        pageDiv.className = 'print-page';
        const subjects = getSubjects();
        const tableRows = chunk.map((s, index) => {
            let total = s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
            let isFail = (s.n.trim() !== "" || total > 0) && (total < passLimit);
            return `<tr>
                        <td>${i+index+1}</td>
                        <td style="text-align:center">${s.n}</td> 
                        <td style="text-align:center">${s.f}</td>
                        ${s.m.map((m, mi) => `<td>${isLocked(mi)?'-':(m||'')}</td>`).join('')}
                        <td class="total-cell">${Math.round(total) || 0}${isFail ? '<span class="fail-text">FAIL</span>' : ''}</td>
                    </tr>`;
        }).join('');

        const isLastPage = (i + studentsPerPage >= filledStudents.length);
        pageDiv.innerHTML = `<div class="a4-head">${document.getElementById('edit-title').value}</div><div class="a4-info-bar"><span>SCHOOL: ${document.getElementById('edit-school').value}</span><span>CLASS: ${currentClass}</span><span>SECTION: ${document.getElementById('sectionInp').value.toUpperCase()}</span><span>EXAM: ${currentMode === '1st' ? '1ST' : 'FINAL'} SEM</span></div><table><thead><tr><th>RN</th><th style="width:150px">STUDENT NAME</th><th style="width:150px">FATHER NAME</th>${subjects.map(s => `<th>${s}</th>`).join('')}<th class="total-cell">TOTAL</th></tr></thead><tbody>${tableRows}</tbody></table>${isLastPage ? `<div class="print-stats-bottom"><span>Students Appeared: ${app}</span><span>Pass: ${pass}</span><span>Fail: ${fail}</span><span>Pass %: ${app > 0 ? Math.round((pass/app)*100) : 0}%</span></div><div class="signature-row"><div class="sig-box">${document.getElementById('sig1-edit').value}</div><div class="sig-box">${document.getElementById('sig2-edit').value}</div>${["6TH", "7TH", "8TH"].includes(currentClass) ? `<div class="sig-box">${document.getElementById('sig3-edit').value}</div>` : ''}</div>` : `<div style="text-align:right; font-size:9pt; margin-top:10px; font-weight:bold;">Page ${Math.floor(i/studentsPerPage)+1} - Continued...</div>`}`;
        container.appendChild(pageDiv);
    }
}


    function updateData(k, v) { students[activeIdx][k] = v; renderTable(); saveToDisk(); }
    function saveToDisk() { localStorage.setItem(getStoreKey(), JSON.stringify(students)); }
    function changeClass(v) { currentClass = v; activeIdx = 0; init(); }
    function changeMode(v) { currentMode = v; activeIdx = 0; WEIGHT = (v === 'Final') ? 1.0 : 0.45; updatePercOptions(); init(); }
    function changePerc(v) { PASS_THRESHOLD = parseFloat(v); updateLiveTotal(); renderTable(); }
    function nav(d) { let next = activeIdx + d; if(next >= 0 && next < 100) load(next); }
    function deleteWholeClass() { if(confirm("DELETE CLASS DATA?")) { localStorage.removeItem(getStoreKey()); activeIdx = 0; init(); } }
    function clearCurrentRow() { if(confirm("Delete student?")) { students[activeIdx] = {n:'', f:'', m:Array(9).fill('')}; load(activeIdx); renderTable(); saveToDisk(); } }

    window.onload = () => { updatePercOptions(); init(); };
</script>

</body>
</html>
