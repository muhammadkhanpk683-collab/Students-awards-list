<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Award List Portal - G.P.S SALOBAIG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --zong-pink: #df1b77; --zong-green: #8cc63f; --bg: #f0f2f5; --save-blue: #007bff; --danger: #dc3545; --dark-slate: #2c3e50; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; }

        .edit-icon-label { font-size: 10px; color: #fff; opacity: 0.8; margin-bottom: 2px; display: block; }
        .input-group { position: relative; margin-bottom: 12px; }
        .input-group i { position: absolute; left: 12px; top: 15px; color: #888; }
        .input-box-icon { padding-left: 35px !important; }

        .app-view { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; padding-bottom: 20px; border: 1px solid #ddd; display: flex; flex-direction: column; }
        .app-header { background: linear-gradient(135deg, var(--zong-pink), #9d1252); color: white; padding: 15px; text-align: center; }
        
        .header-edit-container { position: relative; margin-bottom: 8px; }
        .header-edit-container i { position: absolute; right: 10px; top: 10px; font-size: 12px; color: rgba(255,255,255,0.7); pointer-events: none; }
        .edit-head { width: 100%; background: rgba(255,255,255,0.15); border: 1px dashed white; color: white; text-align: center; border-radius: 5px; padding: 8px; font-weight: bold; outline: none; padding-right: 30px; }
        
        .top-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #fff; border-bottom: 2px solid #eee; position: sticky; top: 0; z-index: 100; }
        .btn { padding: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 12px; }

        .form-section { padding: 15px; flex-grow: 1; }
        .student-card { background: white; padding: 15px; border-radius: 15px; border: 1.5px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .input-box { width: 100%; padding: 12px; border: 1.2px solid #ccc; border-radius: 10px; font-size: 16px; font-weight: 600; outline: none; }

        .subjects-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .sub-card { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 8px; border-radius: 10px; text-align: center; position: relative; }
        .sub-card.locked { background: #ffebee !important; border: 1px solid #ffcdd2 !important; opacity: 0.9; }
        .sub-card label { display: block; font-size: 10px; font-weight: 900; margin-bottom: 2px; color: var(--dark-slate); }
        .sub-card i.edit-dot { font-size: 7px; color: var(--zong-pink); position: absolute; right: 5px; top: 5px; }
        .sub-card input { width: 100%; border: none; background: transparent; text-align: center; font-size: 18px; font-weight: bold; outline: none; border-bottom: 1px solid transparent; }
        .sub-card input:focus { border-bottom: 1px solid var(--zong-pink); }
        
        .total-box { margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 10px; text-align: center; font-weight: 900; border: 2px solid var(--zong-green); }
        .nav-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 0 10px; }
        .nav-btn { background: #444; color: white; border: none; padding: 12px 18px; border-radius: 30px; font-weight: 900; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }

        .sig-settings { margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        .sig-settings label { font-size: 11px; font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px; }
        .sig-input-wrapper { position: relative; }
        .sig-input-wrapper i { position: absolute; right: 8px; top: 8px; font-size: 10px; color: #aaa; }
        .sig-input { width: 100%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; padding-right: 20px; }

        /* Modified Icon Wrapper for Top Selectors to ensure text visibility */
        .top-input-icon-wrapper { position: relative; display: flex; align-items: center; }
        .top-input-icon-wrapper i { position: absolute; left: 8px; color: #555; z-index: 5; pointer-events: none; font-size: 12px; } /* Smaller icon */
        .icon-padding { padding-left: 25px !important; padding-right: 5px !important; } /* Reduced padding for more text space */

        .app-footer { text-align: center; padding: 15px; color: #666; font-size: 13px; border-top: 1px solid #eee; }

        #dynamic-print-container { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .no-print { display: none !important; }
            #dynamic-print-container { display: block !important; width: 100%; }
            .print-page { width: 210mm; height: 296mm; padding: 10mm; margin: 0 auto; page-break-after: always; position: relative; box-sizing: border-box; }
            .a4-head { text-align: center; text-decoration: underline; font-size: 16pt; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; }
            .a4-info-bar { display: flex; justify-content: space-between; font-weight: 900; font-size: 10pt; margin-bottom: 10px; border-bottom: 2px solid black; padding-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; border: 2px solid black; table-layout: fixed; }
            th, td { border: 1px solid black; text-align: center; padding: 3px; font-size: 8.5pt; font-weight: 900; height: 25px; overflow: hidden; }
            .fail-text { color: red !important; font-size: 7pt; display: block; line-height: 0.8; }
            .print-stats-bottom { font-weight: 900; font-size: 10pt; display: flex; justify-content: space-around; border-top: 1px dashed black; padding-top: 10px; margin-bottom: 40px; }
            .signature-row { display: flex; justify-content: space-around; }
            .sig-box { border-top: 1.5px solid black; width: 150px; text-align: center; font-weight: bold; font-size: 10pt; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="app-view no-print">
    <div class="app-header">
        <div class="header-edit-container">
            <span class="edit-icon-label"><i class="fas fa-edit"></i> Click to edit list title</span>
            <input type="text" id="edit-title" class="edit-head" value="STUDENT AWARD LIST - 2026" oninput="renderTable()">
            <i class="fas fa-pen-nib"></i>
        </div>
        <div class="header-edit-container">
            <span class="edit-icon-label"><i class="fas fa-edit"></i> Click to edit school name</span>
            <input type="text" id="edit-school" class="edit-head" value="G.P.S SALOBAIG" oninput="renderTable()">
            <i class="fas fa-pen-nib"></i>
        </div>
    </div>

    <div class="top-nav">
        <button class="btn" style="background:var(--save-blue)" onclick="saveToDisk()"><i class="fas fa-save"></i> SAVED</button>
        <button class="btn" style="background:var(--zong-green)" onclick="downloadPDF()"><i class="fas fa-file-download"></i> DOWNLOAD PDF</button>
        <button class="btn" style="background:#28a745" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> EXCEL EXPORT</button>
        <button class="btn" style="background:orange; color:black" onclick="clearCurrentRow()"><i class="fas fa-user-minus"></i> DELETE STUDENT</button>
        <button class="btn" style="background:var(--danger)" onclick="deleteWholeClass()"><i class="fas fa-trash-alt"></i> DELETE CLASS DATA</button>
        <button class="btn" style="background:var(--danger); grid-column: span 1;" onclick="clearAllSystemData()">
            <i class="fas fa-exclamation-triangle"></i> DELETE ALL DATA 
        </button>
    </div>

    <div class="form-section">
        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
            <div style="display:flex; gap:8px;">
                <div class="top-input-icon-wrapper" style="flex:1.5;">
                    <i class="fas fa-chalkboard"></i>
                    <select id="classSel" onchange="changeClass(this.value)" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border:1px solid #ccc; font-size:12px;">
                        <option value="KG">Class: KG</option>
                        <option value="1ST">Class: 1ST</option>
                        <option value="2ND">Class: 2ND</option>
                        <option value="3RD">Class: 3RD</option>
                        <option value="4TH">Class: 4TH</option>
                        <option value="5TH">Class: 5TH</option>
                        <option value="6TH">Class: 6TH</option>
                        <option value="7TH">Class: 7TH</option>
                        <option value="8TH">Class: 8TH</option>
                    </select>
                </div>
                
                <div class="top-input-icon-wrapper" style="width:65px; flex:none;">
                    <i class="fas fa-layer-group"></i>
                    <input type="text" id="sectionInp" placeholder="Sec" value="A" oninput="renderTable()" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; text-align:center; border:1px solid #ccc; font-size:12px;">
                </div>

                <div class="top-input-icon-wrapper" style="flex:2;">
                    <i class="fas fa-file-signature"></i>
                    <select id="modeSel" onchange="changeMode(this.value)" class="icon-padding" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border:1px solid #ccc; font-size:11px;">
                        <option value="1st">1st Sem (45%)</option>
                        <option value="Final">Annual exam</option>
                    </select>
                </div>
            </div>

            <div id="percCont" style="display: none; margin-top: 5px;">
                <select id="percSel" onchange="changePerc(this.value)" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; border: 2px solid var(--zong-green);"></select>
            </div>
            <div class="sig-settings">
                <label><i class="fas fa-signature"></i> Edit Signature Titles:</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div class="sig-input-wrapper"><input type="text" id="sig1-edit" class="sig-input" value="Class Teacher" oninput="renderTable()"><i class="fas fa-marker"></i></div>
                    <div class="sig-input-wrapper"><input type="text" id="sig2-edit" class="sig-input" value="Head Master" oninput="renderTable()"><i class="fas fa-marker"></i></div>
                </div>
                <div id="sig3-cont" style="display:none" class="sig-input-wrapper"><input type="text" id="sig3-edit" class="sig-input" value="Controller of Exam" oninput="renderTable()"><i class="fas fa-marker"></i></div>
            </div>
        </div>

        <div class="student-card">
            <div id="roll-info" style="font-weight:900; color:var(--zong-pink); margin-bottom:10px;"><i class="fas fa-id-badge"></i> Roll No: 1</div>
            <div class="input-group"><i class="fas fa-user-graduate"></i><input type="text" id="sName" class="input-box input-box-icon" placeholder="Student Name" oninput="updateData('n', this.value)"></div>
            <div class="input-group"><i class="fas fa-users"></i><input type="text" id="fName" class="input-box input-box-icon" placeholder="Father Name" oninput="updateData('f', this.value)"></div>
            <div class="subjects-grid" id="subGrid"></div>
            <div id="total-container" class="total-box">TOTAL: <span id="live-total" style="color:var(--zong-pink); font-size:22px;">0</span> <span id="live-status" style="font-size: 12px; padding: 2px 8px; border-radius: 5px; color: white; margin-left: 10px;"></span></div>
        </div>

        <div class="nav-controls">
            <button class="nav-btn" onclick="nav(-1)"><i class="fas fa-chevron-left"></i> PREVIOUS</button>
            <span id="page-indicator" style="font-weight:900; font-size:18px; color:#444;">1 / 100</span>
            <button class="nav-btn" onclick="nav(1)">NEXT <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
    
    <footer class="app-footer no-print">Developed by: <strong>Sajjad Ali Humdard</strong><br><a href="https://wa.me/923073736743" style="color: #25D366; text-decoration: none; font-weight: bold;"><i class="fab fa-whatsapp"></i> Help support</a></footer>
</div>

<div id="dynamic-print-container"></div>

<script>
    let WEIGHT = 0.45, PASS_THRESHOLD = 0.33, currentMode = "1st", currentClass = "KG", activeIdx = 0, maxReachedIdx = 0, students = [];

    function clearAllSystemData() { if(confirm("DANGER: Wipe all data?")) { localStorage.clear(); location.reload(); } }
    function getStoreKey() { return 'AwardData_ModeSplit_' + currentClass + '_' + currentMode; }
    
    function getPassCriteria() {
        if (currentMode === "Final") {
            let maxMarks = (currentClass === "KG") ? 500 : (["1ST", "2ND", "3RD"].includes(currentClass)) ? 700 : (["4TH", "5TH"].includes(currentClass)) ? 800 : 900;
            return maxMarks * PASS_THRESHOLD;
        }
        return (currentClass === "KG") ? 74 : (["1ST", "2ND", "3RD"].includes(currentClass)) ? 102 : (["4TH", "5TH"].includes(currentClass)) ? 118 : 133;
    }

    function updatePercOptions() {
        const container = document.getElementById('percCont');
        if(currentMode === "Final") {
            container.style.display = "block"; document.getElementById('percSel').innerHTML = '';
            for(let i=10; i<=45; i++) {
                let opt = document.createElement('option'); opt.value = i/100; opt.innerHTML = `Set Passing Marks: ${i}%`;
                if(i === 33) opt.selected = true; document.getElementById('percSel').appendChild(opt);
            }
        } else { container.style.display = "none"; PASS_THRESHOLD = 0.33; }
    }

    function getSubjects() {
        if (["1ST", "2ND", "3RD"].includes(currentClass)) return ["ENG","URD","MAT","G.K","ISL","NQ","PSH","S.S","D.G"];
        if (["6TH", "7TH", "8TH"].includes(currentClass)) return ["ENG","URD","MAT","SCI","ISL","ARB","HIS","GEO","COMP"];
        return ["ENG","URD","MAT","SCI","ISL","NQ","PSH","S.S","D.G"];
    }

    function isLocked(mi) {
        if (currentClass === "KG") return [3, 4, 5, 7].includes(mi);
        if (["1ST", "2ND", "3RD"].includes(currentClass)) return [7].includes(mi);
        return false;
    }

    function init() {
        let saved = JSON.parse(localStorage.getItem(getStoreKey()));
        students = saved || Array.from({length: 100}, () => ({n:'', f:'', m:Array(9).fill('')}));
        let lastFilled = 0; students.forEach((s, i) => { if(s.n || s.f) lastFilled = i; });
        maxReachedIdx = lastFilled;
        const subjects = getSubjects();
        document.getElementById('subGrid').innerHTML = subjects.map((s, i) => {
            const locked = isLocked(i);
            return `<div class="sub-card ${locked ? 'locked' : ''}">${locked ? '' : '<i class="fas fa-pencil-alt edit-dot"></i>'}<label>${s}</label><input type="text" inputmode="decimal" id="m-${i}" onblur="manualMarkEntry(${i}, this.value)" ${locked ? 'disabled' : ''}></div>`;
        }).join('');
        document.getElementById('sig3-cont').style.display = ["6TH", "7TH", "8TH"].includes(currentClass) ? 'block' : 'none';
        load(activeIdx);
    }

    function load(idx) {
        activeIdx = idx; if(idx > maxReachedIdx) maxReachedIdx = idx;
        const s = students[activeIdx];
        document.getElementById('roll-info').innerHTML = `<i class="fas fa-id-badge"></i> Roll No: ` + (idx + 1);
        document.getElementById('page-indicator').innerText = (idx + 1) + " / 100";
        document.getElementById('sName').value = s.n || ""; document.getElementById('fName').value = s.f || "";
        getSubjects().forEach((_, i) => { let input = document.getElementById(`m-${i}`); if(input) input.value = s.m[i] || ""; });
        updateLiveTotal(); renderTable();
    }

    function manualMarkEntry(mi, val) {
        if (val === "") { students[activeIdx].m[mi] = ''; } 
        else {
            let num = parseFloat(val); const subjects = getSubjects(); const currentSub = subjects[mi];
            if (currentSub === "ISL" && num > 60) { alert("Islamiat max 60"); num = 60; } 
            else if (currentSub === "NQ" && num > 40) { alert("Nazra Quran max 40"); num = 40; } 
            else if (num > 100) { alert("Max 100"); num = 100; }
            let finalVal = (currentMode === "1st") ? (num * 0.45).toFixed(1) : num;
            students[activeIdx].m[mi] = finalVal; document.getElementById(`m-${mi}`).value = finalVal;
        }
        updateLiveTotal(); renderTable(); saveToDisk();
    }

    function updateLiveTotal() {
        let total = students[activeIdx].m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
        document.getElementById('live-total').innerText = Math.round(total);
        const st = document.getElementById('live-status'); const passLimit = getPassCriteria();
        if (total >= passLimit && (students[activeIdx].n !== "" || total > 0)) { st.innerText = "PASS"; st.style.backgroundColor = "var(--zong-green)"; } 
        else { st.innerText = "FAIL"; st.style.backgroundColor = "var(--danger)"; }
    }

    function downloadPDF() {
        const schoolName = document.getElementById('edit-school').value.replace(/\s+/g, '_');
        const originalTitle = document.title; document.title = `${schoolName}_Class_${currentClass}_AwardList`;
        window.print(); setTimeout(() => { document.title = originalTitle; }, 1000);
    }

    function exportToExcel() {
        const title = document.getElementById('edit-title').value;
        const school = document.getElementById('edit-school').value;
        const section = document.getElementById('sectionInp').value.toUpperCase();
        const subjects = getSubjects();
        
        let csv = `"${title}"\n`;
        csv += `"${school}","","CLASS: ${currentClass}","SECTION: ${section}","EXAM: ${currentMode.toUpperCase()}"\n\n`;
        csv += 'Roll No,Student Name,Father Name,' + subjects.join(',') + ',Total\n';
        
        students.slice(0, maxReachedIdx + 1).forEach((s, i) => {
            if(s.n || s.f) {
                let total = Math.round(s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0));
                csv += `${i+1},"${s.n}","${s.f}",${s.m.join(',')},${total}\n`;
            }
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `${school}_Class_${currentClass}_AwardList.csv`);
        link.click();
    }

    function renderTable() {
        let app = 0, pass = 0, fail = 0; const passLimit = getPassCriteria();
        const studentsPerPage = 32; const filledStudents = students.slice(0, maxReachedIdx + 1);
        filledStudents.forEach(s => {
            let total = s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
            if(s.n.trim() !== "" || total > 0) { app++; if(total >= passLimit) pass++; else fail++; }
        });
        const container = document.getElementById('dynamic-print-container'); container.innerHTML = ''; 
        for (let i = 0; i < filledStudents.length; i += studentsPerPage) {
            const chunk = filledStudents.slice(i, i + studentsPerPage);
            const pageDiv = document.createElement('div'); pageDiv.className = 'print-page';
            const subjects = getSubjects();
            const tableRows = chunk.map((s, index) => {
                let total = s.m.reduce((a, b) => a + (parseFloat(b) || 0), 0);
                let isFail = (s.n.trim() !== "" || total > 0) && (total < passLimit);
                return `<tr><td>${i+index+1}</td><td style="text-align:left">${s.n}</td><td style="text-align:left">${s.f}</td>${s.m.map((m, mi) => `<td>${isLocked(mi)?'-':(m||'')}</td>`).join('')}<td class="total-cell">${Math.round(total) || 0}${isFail ? '<span class="fail-text">FAIL</span>' : ''}</td></tr>`;
            }).join('');
            const isLastPage = (i + studentsPerPage >= filledStudents.length);
            pageDiv.innerHTML = `<div class="a4-head">${document.getElementById('edit-title').value}</div><div class="a4-info-bar"><span>SCHOOL: ${document.getElementById('edit-school').value}</span><span>CLASS: ${currentClass}</span><span>SECTION: ${document.getElementById('sectionInp').value.toUpperCase()}</span><span>EXAM: ${currentMode === '1st' ? '1ST' : 'FINAL'} SEM</span></div><table><thead><tr><th>RN</th><th style="width:150px">STUDENT NAME</th><th style="width:150px">FATHER NAME</th>${subjects.map(s => `<th>${s}</th>`).join('')}<th class="total-cell">TOTAL</th></tr></thead><tbody>${tableRows}</tbody></table>${isLastPage ? `<div class="print-stats-bottom"><span>Appeared: ${app}</span><span>Pass: ${pass}</span><span>Fail: ${fail}</span><span>Pass %: ${app > 0 ? Math.round((pass/app)*100) : 0}%</span></div><div class="signature-row"><div class="sig-box">${document.getElementById('sig1-edit').value}</div><div class="sig-box">${document.getElementById('sig2-edit').value}</div>${["6TH", "7TH", "8TH"].includes(currentClass) ? `<div class="sig-box">${document.getElementById('sig3-edit').value}</div>` : ''}</div>` : `<div style="text-align:right; font-size:9pt; margin-top:10px; font-weight:bold;">Page ${Math.floor(i/studentsPerPage)+1} - Continued...</div>`}`;
            container.appendChild(pageDiv);
        }
    }

    function updateData(k, v) { students[activeIdx][k] = v; renderTable(); saveToDisk(); }
    function saveToDisk() { localStorage.setItem(getStoreKey(), JSON.stringify(students)); }
    function changeClass(v) { currentClass = v; activeIdx = 0; init(); }
    function changeMode(v) { currentMode = v; activeIdx = 0; WEIGHT = (v === 'Final') ? 1.0 : 0.45; updatePercOptions(); init(); }
    function changePerc(v) { PASS_THRESHOLD = parseFloat(v); updateLiveTotal(); renderTable(); }
    function nav(d) { let next = activeIdx + d; if(next >= 0 && next < 100) load(next); }
    function deleteWholeClass() { if(confirm("DELETE CLASS DATA?")) { localStorage.removeItem(getStoreKey()); activeIdx = 0; init(); } }
    function clearCurrentRow() { if(confirm("Delete student?")) { students[activeIdx] = {n:'', f:'', m:Array(9).fill('')}; load(activeIdx); renderTable(); saveToDisk(); } }

    window.onload = () => { updatePercOptions(); init(); };
</script>

</body>
</html>
